# CODEX Diary

Code review history and findings. Updated by Codex during each review.

---

## Accepted / Won't Fix

These findings have been reviewed by the developer and are intentional:

- **Container entrypoint fails if Codex auth fails.** This is expected behavior.
  Codex auth is required for code review to work, so failing fast on first-run
  is the correct approach. The user must complete the OAuth flow before proceeding.
  Do not flag this again.

- **`reset.sh` dotfile glob.** Fixed in M3 — now uses rm-and-recreate instead
  of globbing. Do not flag this again.

- **Codex symlink in spec.** No symlink reference exists in MOARCODE.md. The
  Dockerfile installs codex via npm globally and `codereview.sh` uses
  `command -v codex`. This is correct. Do not flag this again.

- **Firewall does not cover IPv6.** Accepted for v1. The firewall is optional
  and documented as such. IPv6 hardening is a future enhancement, not a blocker.
  Do not flag this again.

- **NET_ADMIN/NET_RAW caps always granted.** Accepted for v1. The caps are
  harmless without the firewall script being invoked, and gating them behind a
  flag adds complexity for minimal benefit. Do not flag this again.

- **`develop.sh` trusts `.project-name` without re-validation.** The file is
  machine-generated by `install.sh` which already sanitizes. If someone
  hand-edits the dotfile and breaks it, Docker fails immediately with a clear
  error. Duplicating sanitization logic means two places to maintain for a
  scenario that doesn't happen in practice. Do not flag this again.

---

## Compacted Review History (2026-02-06 through 2026-02-07)

Nine reviews were conducted during M1–M4. Key findings and their resolutions:

### Fixed
- **`reset.sh` dotfile glob** — `rm -rf .*` expanded to `.`/`..`. Fixed in M3: replaced with rm-and-recreate.
- **Leading hyphens in project name** — `install.sh` didn't strip them, breaking Docker commands. Fixed in M4.
- **Docs/spec drift** — Multiple rounds caught `MOARCODE.md` references after it was replaced by `README.md` + `docs/architecture.md`. Fixed in M4.
- **`develop.sh` fallback name unsanitized** — Fallback from parent directory wasn't lowercased or stripped. Fixed alongside project name validation.

### Accepted (see above)
- Container hard-fails on Codex auth failure (intentional — auth is required)
- Firewall IPv6 gap (optional feature, documented limitation)
- NET_ADMIN/NET_RAW always granted (harmless without firewall invocation)
- `develop.sh` doesn't re-validate `.project-name` (machine-generated file)

---

## Review — 2026-02-07 11:10:40 UTC

### Findings

1. **Project name sanitization can still produce invalid Docker image/volume names.**
   - **Where:** `moarcode/install.sh`, `moarcode/develop.sh`
   - **Why:** The sanitizer only strips leading `[-_]` and a single trailing `-`, and it does not collapse existing repeated separators (e.g. `my--project`) or trim trailing `_`. Docker image names require components like `[a-z0-9]+([._-][a-z0-9]+)*`; trailing `_`/`-` or repeated separators are invalid. This can break `docker build -t` and `docker volume create` if the directory name or user input contains consecutive separators or ends with `_`.
   - **Impact:** `./develop.sh` can fail even after “successful” install if the project name is malformed in those edge cases.
   - **Fix idea:** Normalize consecutive separators and trim all trailing separators (e.g. `sed 's/[-_][-_]*/-/g; s/^[-_]*//; s/[-_]*$//'`). Apply in both `install.sh` and the fallback in `develop.sh`.

2. **Implementation plan still references removed `MOARCODE.md` and no longer matches docs.**
   - **Where:** `moarcode/IMPLEMENTATION.md`
   - **Why:** M3/M4 tasks mention reviewing/updating `MOARCODE.md`, but the repo now uses `README.md` + `docs/architecture.md`. This is a direct plan/documentation mismatch.
   - **Impact:** New contributors following the plan will look for the wrong file and may miss required doc updates.
   - **Fix idea:** Update M4 tasks and acceptance criteria to reference `README.md` and `docs/architecture.md` instead of `MOARCODE.md`.

### Parting Wisdom Before v1

- The core architecture is sound: Dockerized runtime, credential bind mounts, and explicit review loop are cohesive and minimal. The remaining risks are mostly edge-case polish.
- Tighten the project name sanitizer now to avoid user-facing Docker failures — it’s the most likely “first run” paper cut.
- Refresh the plan to align with the new docs so v1 doesn’t ship with internal drift.

---

## Review — 2026-02-07 11:13:55 UTC

### Findings

1. **IMPLEMENTATION.md still references `MOARCODE.md`, violating the M5 plan-drift fix.**
   - **Where:** `moarcode/IMPLEMENTATION.md`
   - **Why:** M3 tasks still include “Update MOARCODE.md if any discrepancies found,” and M5 acceptance criteria state “No references to `MOARCODE.md` remain,” which the plan itself violates. This contradicts the M5 requirement to remove `MOARCODE.md` references from the plan.
   - **Impact:** The M5 plan-drift fix is incomplete and new contributors may still chase a non-existent doc.
   - **Fix idea:** Replace the M3 task with `README.md` + `docs/architecture.md`, and update the M5 acceptance criteria to avoid self-contradiction (or remove the `MOARCODE.md` mention entirely).

### Not applicable / resolved by other changes
- `install.sh` self-deletion — docs updated to reflect it's a one-shot installer
- Codex symlink — never needed, `command -v` works, old spec removed
- UID/GID `$HOME` ownership — works correctly for the standard case

---

## Review — 2026-02-07 11:16:38 UTC

### Findings

1. **Plan drift remains: `IMPLEMENTATION.md` still references `MOARCODE.md`.**
   - **Where:** `moarcode/IMPLEMENTATION.md`
   - **Why:** M5 Acceptance Criteria includes “No references to `MOARCODE.md` remain in the plan or docs,” but this statement itself is a reference to `MOARCODE.md`. This makes the acceptance criterion self-contradictory and keeps the M3 “MOARCODE.md reference fix” incomplete.
   - **Impact:** The plan cannot satisfy its own acceptance criteria, and new contributors still see a `MOARCODE.md` reference inside the plan.
   - **Fix idea:** Reword the M5 acceptance criterion to avoid naming `MOARCODE.md`, e.g., “Plan and docs contain no references to removed legacy specs.”

---

## Review — 2026-02-07 11:18:20 UTC

### Findings

1. **M5 acceptance criteria not met: IMPLEMENTATION.md still references a removed legacy spec.**
   - **Where:** `moarcode/IMPLEMENTATION.md`
   - **Why:** The M5 task line reads “update M4 tasks and acceptance criteria to reference `README.md` and `docs/architecture.md` instead of `MOARCODE.md`.” This is still a direct mention of the legacy file inside the plan itself. The M5 acceptance criteria says “Plan and docs reference only current files,” which is violated by that mention.
   - **Impact:** The plan cannot satisfy its own M5 acceptance criteria; contributors still see a legacy spec name in the plan.
   - **Fix idea:** Reword the M5 task to avoid naming the legacy file (e.g., “replace any legacy spec references with README.md + docs/architecture.md”).

2. **Fallback project-name path can produce an empty Docker name.**
   - **Where:** `moarcode/develop.sh`
   - **Why:** If `.project-name` is missing and the parent directory is composed solely of stripped characters (e.g., `___` or `---`), the sanitizer produces an empty string. The script then builds `IMAGE_NAME="moarcode-"` and creates a `-node_modules` volume, which Docker treats as invalid.
   - **Impact:** `./develop.sh` fails with a confusing Docker error for users who run it outside `install.sh` or in oddly named directories.
   - **Fix idea:** After sanitization, guard against an empty `PROJECT_NAME` and exit with a clear error (or prompt for input).

### Final Check

- **M5 clean:** **No** — blocked by the remaining legacy spec mention in `IMPLEMENTATION.md` (Finding 1).

---

## Review — 2026-02-07 11:19:56 UTC

### Findings

None.

### Focus Checks

- **M5 task wording fix:** OK — M5 tasks no longer name the legacy spec; plan references current docs only.
- **`develop.sh` empty name guard:** OK — fallback sanitization now errors out if it produces an empty name.

---

## Review — 2026-02-07 19:12:19 UTC

### Findings

1. **`upgrade.sh` plan lacks a guard to confirm the target is a real moarcode install.**
   - **Where:** `moarcode/tmp/upgrade-plan.md` (Script flow)
   - **Why:** The flow only checks that `TARGET_DIR` exists. If a user runs the script from the wrong directory (or has a `moarcode/` folder that isn't this template), the script could overwrite unrelated files.
   - **Impact:** Risk of clobbering non-moarcode directories in the target project.
   - **Fix idea:** Add a guard that checks for expected markers (e.g., `TARGET_DIR/develop.sh`, `TARGET_DIR/.project-name`, and `TARGET_DIR/CLAUDE.md`) and emit a clear error if they’re missing. Also add a message if the script is run from inside an existing `moarcode/` dir to avoid confusing “not installed” errors.

2. **Template diff prompt does not account for non-interactive usage.**
   - **Where:** `moarcode/tmp/upgrade-plan.md` (Templates step)
   - **Why:** The plan assumes a TTY for `read -r` prompts. In CI or automated scripts, this will block or fail.
   - **Impact:** `upgrade.sh` could hang indefinitely or exit without completing updates in non-interactive contexts.
   - **Fix idea:** Detect TTY (`[ -t 0 ]`) and default to a safe behavior when non-interactive (e.g., auto-overwrite or auto-skip with a warning). Consider a `--yes` or `--skip-templates` flag.

3. **Upgrade flow doesn’t address stale or removed files from older installs.**
   - **Where:** `moarcode/tmp/upgrade-plan.md` (File classification, cleanup)
   - **Why:** Only `install.sh` removal is mentioned. If older installs include files that are later removed or renamed (including an old `upgrade.sh` copied into the target), they’ll linger and cause confusion.
   - **Impact:** Users can end up running outdated scripts or keeping deprecated files.
   - **Fix idea:** Explicitly remove any source-repo-only scripts (`install.sh`, `upgrade.sh`) from the target, and consider a short allowlist cleanup for known-deprecated infra files. At minimum, warn if the target contains files not present in the source infra list.

4. **No defined behavior if a listed infra file is missing in the source.**
   - **Where:** `moarcode/tmp/upgrade-plan.md` (Copy infra files step)
   - **Why:** The plan assumes all infra files exist in the source. If a file is removed in a future release, `cp` will fail and abort the upgrade.
   - **Impact:** Upgrades break on future refactors where infra files are renamed or deleted.
   - **Fix idea:** Iterate the infra list with existence checks; warn and continue (or fail with a specific message) when a file is missing so the behavior is predictable.

---

## Review — 2026-02-07 19:14:45 UTC

### Findings

1. **`upgrade.sh` plan still lacks a robust non-interactive path.**
   - **Where:** `moarcode/tmp/upgrade-plan.md` (Templates step)
   - **Why:** The revised plan adds a `--yes` flag but doesn’t define behavior when stdin is not a TTY and `--yes` is omitted. In CI or scripted runs this can still block on prompts.
   - **Impact:** Upgrades can hang unexpectedly in non-interactive environments unless callers remember `--yes`.
   - **Fix idea:** Detect non-interactive mode (`[ -t 0 ]`) and either auto-apply a safe default or error with a clear message suggesting `--yes`.

2. **`upgrade.sh` target validation is too weak to confirm a real moarcode install.**
   - **Where:** `moarcode/tmp/upgrade-plan.md` (Guard: valid moarcode installation)
   - **Why:** The guard only checks for `develop.sh`. A random directory could contain a `moarcode/` folder with a `develop.sh` file but not be a real install.
   - **Impact:** The upgrade could clobber unrelated content in edge cases where a similarly named folder exists.
   - **Fix idea:** Check multiple markers (e.g., `.project-name`, `CLAUDE.md`, `CODEX-REVIEW-PROMPT.md`) or a single sentinel file to establish identity.

### Upgrade Plan Check (Prior 4 Findings)

- **Guard for real install:** **Partially addressed** (only `develop.sh` check). See Finding 2.
- **Non-interactive prompts:** **Partially addressed** (`--yes` exists, no TTY default). See Finding 1.
- **Stale/removed files:** **Addressed** (explicit cleanup + unexpected file warning).
- **Missing infra source files:** **Addressed** (skip missing files with warning).

---

## Review — 2026-02-07 19:16:44 UTC

### Findings

None.

### Focus Check: moarcode/tmp/upgrade-plan.md (Revised Upgrade Plan)

All previous findings are resolved:
- Guard for real installs now checks multiple markers (develop.sh, Dockerfile, CLAUDE.md)
- Non-interactive usage now defaults to auto-overwrite with a clear note
- Stale/removed files handled (install.sh/upgrade.sh cleanup + unexpected file warnings)
- Missing infra files in source are skipped with warnings

---

## Review — 2026-02-07 19:23:48 UTC

### Findings

1. **`install.sh` leaves a non-functional `upgrade.sh` in installed templates.**
   - **Where:** `moarcode/install.sh`, `moarcode/upgrade.sh`
   - **Why:** `install.sh` copies the full template then deletes `install.sh`, but does **not** delete `upgrade.sh`. The installed copy of `upgrade.sh` refuses to run when `SOURCE_DIR == TARGET_DIR`, which is exactly what happens if a user runs `./moarcode/upgrade.sh` from their project root.
   - **Impact:** Users will see a confusing “already inside a moarcode directory” error from the installed `upgrade.sh`, even though that is the most obvious script to run.
   - **Fix idea:** Remove `upgrade.sh` during install (like `install.sh`), or make the installed copy print a clear message telling users to run the source-repo `upgrade.sh` instead.

---

## Review — 2026-02-07 19:25:14 UTC

### Findings

None.

### Focus Check: install.sh / upgrade.sh

- **Install/upgrade consistency issue:** **Resolved.** `install.sh` now removes `upgrade.sh` from the installed template, and `upgrade.sh` itself cleans up any stale `install.sh`/`upgrade.sh` in target installs. No further issues found in these scripts.

---

## Review — 2026-02-07 19:30:13 UTC

### Findings

None.

### Focus Check

- **upgrade.sh (new script):** OK — guards, non-interactive behavior, template prompting, and cleanup look correct.
- **install.sh fix (remove upgrade.sh in target):** OK — installed template no longer contains a non-functional upgrader.
- **README.md upgrade docs:** OK — matches current upgrade flow and non-interactive default.
- **docs/architecture.md upgrade section:** OK — accurately describes behavior.

---

## Review — 2026-02-07 19:43:01 UTC

### Findings

1. **Resume path lacks an immediate fallback when the stored session ID is invalid or expired.**
   - **Where:** `moarcode/tmp/resume-plan.md` (Implementation → `--continue` flow)
   - **Why:** The plan says to clear the session file on failure and require a fresh run next time. If `codex exec resume` fails (e.g., invalid/expired thread ID), the user must re-run the command manually to get a fresh review.
   - **Impact:** Adds friction and makes `--continue` fragile in the common case of stale sessions.
   - **Fix idea:** If resume fails with an invalid/expired session, automatically fall back to a fresh `codex exec` in the same invocation, then replace `.last-review-session` with the new thread ID.

2. **Resume prompt does not explicitly force re-reading required files or detecting changed files.**
   - **Where:** `moarcode/tmp/resume-plan.md` (prompt for continued reviews)
   - **Why:** The shortened prompt relies on prior context, but the review process explicitly requires reading `CODEX-DIARY.md`, `IMPLEMENTATION.md`, `DIARY.md`, and root `CLAUDE.md`. Without re-reading or at least checking `git status`/`git diff`, Codex can miss updates since the last review.
   - **Impact:** High risk of false “clean” reviews or missed regressions when the developer makes changes between runs.
   - **Fix idea:** In the resume prompt, explicitly instruct Codex to re-read the required files and to run `git status --porcelain` or `git diff --name-only` to identify changed files for focused review.

3. **Session ID capture is underspecified and may be brittle with `--json` streaming output.**
   - **Where:** `moarcode/tmp/resume-plan.md` (Implementation → save session ID)
   - **Why:** `codex exec --json` emits a stream of JSON events; the plan doesn’t define how to robustly extract `thread_id` (e.g., via `jq` on `thread.started`). If parsing fails, `.last-review-session` could be empty or corrupted.
   - **Impact:** `--continue` may silently fall back to fresh runs or fail to resume, undermining the feature.
   - **Fix idea:** Capture stdout to a debug file and extract the `thread_id` with `jq` (or a strict grep with validation). If missing, warn and do not update `.last-review-session`.

### Focus Check: moarcode/tmp/resume-plan.md

- **Gaps/edge cases:** The resume flow needs a robust invalid-session fallback and explicit re-read/change-detection instructions.
- **Feasibility:** The plan is feasible, but depends on reliable JSON parsing for `thread_id` and clear guidance in the resume prompt to avoid stale-context reviews.

---

## Review — 2026-02-07 19:45:25 UTC

### Findings

1. **Resume prompt still doesn't require re-reading mandatory files.**
   - **Where:** `moarcode/tmp/resume-plan.md` (resume prompt text)
   - **Why:** The prompt only instructs `git diff HEAD~1` and `git status` for change detection. It does not explicitly require re-reading `moarcode/CODEX-DIARY.md`, `moarcode/IMPLEMENTATION.md`, `moarcode/DIARY.md`, and the root `CLAUDE.md`, which are mandatory in the workflow.
   - **Impact:** Resumed reviews can miss updated constraints or new findings, leading to false “clean” results.
   - **Fix idea:** Add an explicit instruction in the resume prompt to re-read the required files before assessing changes. Consider using `git diff --name-only` + re-open changed files after the mandatory reads.

2. **Resume prompt assumes `HEAD~1` exists.**
   - **Where:** `moarcode/tmp/resume-plan.md` (resume prompt text)
   - **Why:** `git diff HEAD~1` fails on repos with a single commit or in detached/initial states.
   - **Impact:** The resume prompt can error or return confusing output in new or freshly initialized repos.
   - **Fix idea:** Use `git diff --name-only` (against working tree) or guard with `git rev-parse --verify HEAD~1` and fall back to `git status --porcelain`.

### Focus Check: resume plan revisions (prior 3 findings)

- **Stale session fallback:** **Addressed** — resume failures now fall back to a fresh run in the same invocation.
- **Change detection:** **Partially addressed** — adds `git diff`/`git status`, but still missing mandatory re-read of required files.
- **Session ID parsing:** **Addressed** — plan defines `thread.started` extraction with validation and failure handling.

---

## Review — 2026-02-07 19:46:45 UTC

### Findings

1. **Resume prompt claims staged+unstaged diffs but only names `git diff`.**
   - **Where:** `moarcode/tmp/resume-plan.md` (resume prompt text)
   - **Why:** The prompt says to run “`git diff` (staged + unstaged)”, but plain
     `git diff` shows unstaged changes only. Staged changes require
     `git diff --cached` (or a combined `git diff --name-only` + `git diff --cached`).
   - **Impact:** Resumed reviews can miss staged changes and incorrectly report
     a clean diff when only the index changed.
   - **Fix idea:** Update the prompt to run both `git diff` and `git diff --cached`,
     or use `git diff --name-only` alongside `git status --porcelain` to capture
     staged and unstaged modifications.

### Focus Check: revised resume plan

- **Mandatory file re-reads:** **Resolved** — prompt explicitly re-reads
  `moarcode/CODEX-DIARY.md`, `moarcode/IMPLEMENTATION.md`, `moarcode/DIARY.md`,
  and the root `CLAUDE.md`.
- **`HEAD~1` assumption:** **Resolved** — no longer relies on `git diff HEAD~1`.

---

## Review — 2026-02-07 19:47:57 UTC

### Findings

None.

### Focus Check: moarcode/tmp/resume-plan.md

- **Staged diff issue:** **Resolved** — resume prompt now calls both `git diff` and
  `git diff --cached`.
- **Remaining findings:** **None** — no additional issues found in the resume plan.
